
	; Flimbos Quest imager

		incdir	Includes:
		include	RawDIC.i

		SLAVE_HEADER
		dc.b	1	; Slave version
		dc.b	0	; Slave flags
		dc.l	DSK_1	; Pointer to the first disk structure
		dc.l	Text	; Pointer to the text displayed in the imager window

		dc.b	"$VER: "
Text:		dc.b	"Flimbo's Quest imager V1.1",10,"by Mr.Larmer/Wanted Team on 10.12.1999",0
		cnop	0,4

DSK_1:		dc.l	0		; Pointer to next disk structure
		dc.w	1		; Disk structure version
		dc.w	DFLG_NORESTRICTIONS	; Disk flags
		dc.l	TL_1		; List of tracks which contain data
		dc.l	0		; UNUSED, ALWAYS SET TO 0!
		dc.l	FL_DISKIMAGE	; List of files to be saved
		dc.l	0		; Table of certain tracks with CRC values
		dc.l	0		; Alternative disk structure, if CRC failed
		dc.l	0		; Called before a disk is read
		dc.l	0		; Called after a disk has been read

TL_1:
		TLENTRY 0,0,$1600,SYNC_STD,DMFM_STD
		TLENTRY 1,1,$1600,SYNC_STD,DMFM_NR
		TLENTRY 2,102,$1600,SYNC_STD,DMFM_NR_2
		TLENTRY 103,159,$1600,SYNC_STD,DMFM_NR
		TLENTRY 159,159,2552,SYNC_STD,DMFM_NR_3

		TLEND
DMFM_NR:
		moveq	#0,D4
		moveq	#0,D6
Decode
		move.l	#$55555555,D5

		bsr.b	GetLongWord
		cmp.l	#'FLIM',D0
		bne.b	.error

		bsr.b	GetLongWord
		move.l	D0,D3

		move.w	#$57F,D2
		bsr.b	GetTrackLength
.loop
		bsr.b	GetLongWord

		eor.l	D4,D0
		move.l	D0,(A1)+
		sub.l	D0,D3
		dbf	D2,.loop

		tst.l	D3
		bne.b	.error

		moveq	#IERR_OK,d0
		rts
.error
		moveq	#IERR_CHECKSUM,d0
		rts

GetLongWord
		move.l	(A0)+,D0
		move.l	(A0)+,D1
		and.l	D5,D0
		and.l	D5,D1
		add.l	D0,D0
		or.l	D1,D0
		rts
GetTrackLength
		move.l	a0,-(a7)
		tst.w	D6
		beq.b	.end
		lea	Table(pc),a0
.loop
		cmp.w	(a0)+,D6
		bmi.b	.end
		bne.b	.next
		move.w	(a0),D2
.end
		move.l	(a7)+,a0
		rts
.next
		addq.l	#2,a0
		bra.b	.loop
Table
		dc.w	14,$3CC/4-1
		dc.w	28,$300/4-1
		dc.w	44,$1BC/4-1
		dc.w	57,$10F8/4-1
		dc.w	69,$C1C/4-1
		dc.w	82,$E34/4-1
		dc.w	95,$22C/4-1
		dc.w	102,$A84/4-1
		dc.w	-1

DMFM_NR_2:
		move.w	D0,D6

		move.w	#$A929,d0
		jsr	rawdic_NextMFMword(a5)
		cmp.w	#$2912,(a0)+
		bne.b	.error
		cmp.l	#$4A554AA9,(a0)+
		bne.b	.error
		move.l	(a0)+,D4

		move.w	#$44A2,d0
		jsr	rawdic_NextMFMword(a5)
		addq.l	#2,a0

		bsr.w	Decode
		tst.l	D0
		bne.b	.error

		moveq	#IERR_OK,d0
		rts
.error
		moveq	#IERR_CHECKSUM,d0
		rts
DMFM_NR_3:
		lea	IntroLostData(pc),a0
		move.w	#IntroLostDataEnd-IntroLostData-1,d0
.copy
		move.b	(a0)+,(a1)+
		dbf	d0,.copy

		moveq	#IERR_OK,d0
		rts
IntroLostData
	dc.l	$567FBEBC,$BF3B3D3D,$3B3F3AB9,$BBBC7D78,$F9F80602
	dc.l	$87F4B41C,$0212320A,$32321222,$021C3424,$18081000
	dc.l	$243BD4BE,$3EDF5F8F,$4B02F70F,$0F45A16B,$C1B55A4F
	dc.l	$E0B41206,$01010505,$0A200980,$202D0508,$4A15685F
	dc.l	$C1195659,$F9E9E9F8,$80A3D3F3,$CBF0697A,$47E07AA0
	dc.l	$01193070,$42002818,$60103F41,$6B9206C9,$268040D8
	dc.l	$06026F04,$05DE0941,$DF05A0FA,$0D070700,$86200B20
	dc.l	$21C0C183,$4B0010C2,$19784BE0,$80A7C100,$040C7E7E
	dc.l	$1285B410,$CA307304,$801000C0,$E8080811,$18538930
	dc.l	$081B0157,$D7E16814,$0F30A8B2,$40E72889,$000C3240
	dc.l	$E00181E0,$2041506F,$07A6698F,$C100120F,$7CFCFD10
	dc.l	$0140EFC0,$4E240DDE,$481EFC90,$38005063,$F3C0E303
	dc.l	$81C00703,$340207ED,$2C0F8E48,$1A05673C,$0E002419
	dc.l	$00103F09,$207E93C0,$E003C180,$47DBE7CF,$BFDF9FBF
	dc.l	$9F8FA074,$CB80C3C3,$C34340C0,$C12023C0,$20C083F0
	dc.l	$561E060E,$1E0A1202,$02080408,$0BEDF1F1,$ECF0F8E8
	dc.l	$FF60E4EE,$1E025704,$05EEEE3E,$BFDF7E40,$2120E0D0
	dc.l	$D1D0B071,$B031B1F1,$88898849,$B1E1E12F,$8D878B82
	dc.l	$8D020BF7,$797EBA3D,$D6DA0F07,$6995CDED,$9DAD8DDD
	dc.l	$C3B387B7,$AF903874,$3C726A6A,$5A060E0E,$01311101
	dc.l	$3E1E1631,$496D251E,$326847D1,$DEF692A2,$7598B5D6
	dc.l	$F44C4C8E,$F4B6D756,$B70DAE5C,$7C8341C1,$62935033
	dc.l	$71098B49,$29686A2A,$A3EBCC40,$5D55C4D4,$4C4695FD
	dc.l	$656864B8,$BAAD3538,$B9BBBBA7,$A5A2B727,$31B0697A
	dc.l	$FFE4181D,$188B1F36,$4880ED29,$452D7575,$7D053E43
	dc.l	$3F4D7139,$6A37A5F5,$8EFCF2F2,$82F48AC6,$96B6FAC6
	dc.l	$F2EC82CE,$E1A183EF,$D7DFCC72,$227A7E3E,$5E717959
	dc.l	$79355505,$1A7DAA26,$EA963ADC,$F4D8F7D3,$13DD2539
	dc.l	$E5C5F935,$1DDDEDED,$2DD56535,$9D23EBD7,$7F1070B8
	dc.l	$64948CBC,$8282E232,$F8E18234,$55149544,$75BDF545
	dc.l	$C4299E27,$E75BB24A,$EB21CC64,$0CF4F6B7,$11F125DA
	dc.l	$46A62FC0,$211009C8,$281881D2,$60206346,$45534B45
	dc.l	$5D45505B,$57DCCA5A,$418FFB7D,$6460ACA4,$AB3D38B5
	dc.l	$A3A075B6,$BCAB28B1,$BFAE68F5,$FDE80308,$9A859B8B
	dc.l	$93884C9C,$1A0ACA1A,$4035E4A4,$64B45DD5,$8579D0AF
	dc.l	$C6A6EA32,$4AC1F7ED,$9752D8DC,$D35B5358,$5156D835
	dc.l	$3A7FF807,$084E464D,$4DC0242D,$208F1F59,$5943DE8A
	dc.l	$A202A69E,$8AD2F2D8,$B76BF395,$20E4D3CF,$4D4EAB68
	dc.l	$EB686FAF,$CF4EA81D,$1E5EB8FA,$7BF9C522,$A36217E4
	dc.l	$14959250,$51555394,$94C7B194,$91BB9A80,$809C31F8
	dc.l	$D8D55641,$48381DF2,$9BDB7ABA,$1B1AAA0A,$6B7A2756
	dc.l	$9E40C0D0,$C86869D8,$61CDAA2B,$20A47D51,$5145454E
	dc.l	$4256CDCE,$41425D0C,$F36E78BF,$34ACBB38,$B9ADBBA3
	dc.l	$BDA9A4AF,$2AB7AE72,$FBF7E7F6,$0300919F,$8858489D
	dc.l	$0E2992AE,$A2B88888,$8F0F3DB3,$BA82BF0A,$2ED8CF7E
	dc.l	$467E4941,$697B776F,$7B4B7361,$417D4F54,$F6C7C828
	dc.l	$2A1E2939,$231F00B8,$8CBC9CB4,$A53DA504,$0F490A69
	dc.l	$B91BC88B,$E13ECE8D,$D4E7E415,$E4E7D443,$94C5F26B
	dc.l	$29CE2B6C,$99D8FE43,$F80342C0,$22629616,$14874984
	dc.l	$AC86BC80,$A08F0700,$B68D96B8,$B71A39CC,$DF556E76
	dc.l	$69497973,$7F60FB6B,$4B655A3C,$D517560F,$DE01FEA0
	dc.l	$F1A968B8,$84F8F844,$252464E5,$C4C461C3,$2DC4A364
	dc.l	$632C2C44,$FCB13ADA,$595D5256,$535DDFD7,$D5D1D8D4
	dc.l	$5157D8BB,$BAF10509,$0E8C4240,$C4238FC1,$49395959
	dc.l	$25315161,$5E0E610D,$53256116,$44138981,$9ADCD870
	dc.l	$CA1494B5,$10D2EDEE,$6EAD2A69,$185F39FA,$808787C2
	dc.l	$24A76113,$17159292,$92579494,$90976362,$D2D09413
	dc.l	$6440399F,$ECA82C2C,$AFCBC9AB,$6AECE8A7,$86834D73
	dc.l	$70F00700,$28782C52,$5232665E,$11795960,$78016222
	dc.l	$5292FCEC,$9C4AD25C,$1C64001B,$D36D8579,$A58505B5
	dc.l	$DDBD0383,$036DB5CD,$03939B0F,$00E008F8,$E474CCDC
	dc.l	$84EBF713,$97945155,$95246FC1,$C3CB2EA0,$21C24209
	dc.l	$77303B5A,$579D9251,$5AD43936,$37DDDAD8,$D3D337B7
	dc.l	$7FF30487,$8E48C6C5,$CB8FB971,$69394D0D,$59096141
	dc.l	$2E611535,$1E6A4267,$D9B9BE8A,$A2AAA2BC,$C6AEA478
	dc.l	$698FF475,$B436F7CF,$EDDE01C0,$2303F8D6,$899B8040
	dc.l	$54525A51,$4156524C,$441FF6FC,$22E2AC14,$48DFBBD3
	dc.l	$83750579,$F905555D,$236343BD,$ED4D6D43,$8B274F7F
	dc.l	$50883854,$ACEC1CD8,$E1901312,$57562F6D,$2DC6C3CF
	dc.l	$CBC9C747,$8908F5B9,$3DD5585C,$5C5152DD,$0EE37BC0
	dc.l	$67BBA87A,$6D7CFDE4,$0113188A,$9E85939F,$90444E49
	dc.l	$461FD068,$80AF0F2F,$3B03313A,$3FE9D6E8,$D3454579
	dc.l	$51636F74,$3905BB3E,$83D2D3EB,$07F73F10,$48389474
	dc.l	$4C5CBC82,$C2320A0A,$F2D2D0FA,$F3E7E011,$E3662047
	dc.l	$FEB9DC9B,$ED6BAEA8,$AA6CEC87,$D7ADEFD0,$3C3E34B8
	dc.l	$7F71F20F,$0E824D40,$CEC3CC22,$25250FE9,$3969315E
	dc.l	$0E3E3E0E,$66325400,$47BDB9E1,$EEC6EABA,$C6D6D872
	dc.l	$CA0C0FF5,$0DB4995A,$3BBF7807,$0443C726,$A2070C87
	dc.l	$0F18A2A2,$8CB4A8B9,$814E4E36,$21E87833,$D5FED4FF
	dc.l	$5763456D,$574F5F78,$F8D0FF70,$D8C2C6C5,$D3F7F03C
	dc.l	$1A0E3125,$2A3864F9,$85A46525,$450478B9,$F9383919
	dc.l	$C9F12180,$9F0ED747,$FB5A5BDB,$7B11FD04,$8D0C0C8F
	dc.l	$4D2EED9F,$DD7E00C3,$A3E09183,$81DE9597,$94465642
	dc.l	$445F8390,$1DB69C74,$64D8B0FF,$8FD7FB4B,$E33DDD1D
	dc.l	$DDA3E0F7,$55191E1D,$1B9B5C3B,$2F62FBF1,$0C8F8A4A
	dc.l	$27D69195,$9F92425C,$44405B8D,$9B9B9E82,$9F11021C
	dc.l	$324F671B,$CB93BDDD,$3DFD2353,$D31320FA,$83E7360E
	dc.l	$8389FFD0,$A8444D28,$28691986,$09F20909,$70737031
	dc.l	$32329363,$A0C083FE,$CEE7700C,$98D0D0D8,$F8D8E4F8
	dc.l	$C4C03864,$9737F64E,$AEDF7FC0,$9001D3E7,$8061C695
	dc.l	$838F9F84,$0C93033D,$0B230511,$2A242027,$FDF9EEF2
	dc.l	$FCD4C4F4,$FCDCDCCC,$ECF4ECE2,$F6FED9C3,$FBCFE01C
	dc.l	$321A2E01,$31392D1B,$070F2F1B,$13333D25,$3AD54908
	dc.l	$D16141FE,$DEEF8E76,$57176766,$16E7E717,$17E75736
	dc.l	$B7F62F6F,$1FBE81C1,$E0D0B1B1,$70B1E9A9,$40C2C2CE
	dc.l	$C4C34346,$42480E75,$1C343850,$4057AB8B,$A3CDF58D
	dc.l	$D5C5F5ED,$8DCDBDDD,$EDBDA3B3,$BBF7EFE0,$68147A39
	dc.l	$A0620CD2,$2322A6A2,$A0A72326,$242227C3,$42478087
	dc.l	$07BDBBFD,$C5C1F059,$4DCDDD9D,$8DADEDB0,$D227E797
	dc.l	$374F253C,$0121029A,$32E85878,$0484C424,$64440404
	dc.l	$7898E848,$70E0C090,$EFB37879,$BCBD3C3F,$DDDFD9D9
	dc.l	$DC3D3A3D,$3EBCBCB8,$7B7AFFFD,$87F49401,$0D140C4C
	dc.l	$2C1C5C6C,$1C7C3C6C,$6C4C2450,$74184080,$8103B17C
	dc.l	$7BBA1022,$085D5D5F,$5CDD5DDD,$8A95BA7E,$7A3D2A09
	dc.l	$090B0F02,$7A491515,$03030480,$168E8280,$8B050606
	dc.l	$2B8BEDBE,$050BDC3E,$DD1817BF,$BC7A3522,$FAF4F425
	dc.l	$0A7C8D68,$18185844,$78782424,$44046464,$38585868
	dc.l	$30487B28,$DC4FC0E1,$134DF9E9,$E9E1E9F5,$EDF5E3EB
	dc.l	$F3F81D02,$5FDF8340,$84D20A1A,$160E1A12,$0C54A469
	dc.l	$010E0A0C,$0550A346,$3BE0A09B,$C7E7E7FB,$C8197783
	dc.l	$D29A1A12,$C000A60C,$B1A60508,$300FACC1,$21408CAA
	dc.l	$0E7110CB,$7C7E0754,$F803ABF1,$F1FEF6F9,$F3F662D4
	dc.l	$53E8DC4F,$08E002EA,$D0505010,$C2340942,$4C00B21C
	dc.l	$4AE04D91,$FEFC302A,$11D4996F,$F40A0462,$8A88B8CC
	dc.l	$0C1408F4,$A029AAD2,$491C11D8,$A12081E3,$8BD16622
	dc.l	$81804DB5,$712C8B07,$01022D24,$CBD27F03,$F1760564
	dc.l	$542DFBF8,$6408001D,$26AAA828,$1FA5D93C,$4C82A370
	dc.l	$021A52B3,$45E29093,$07623F9F,$84652116,$5815F9FC
	dc.l	$1B6612C7,$94605644,$80821E16,$44103EA1,$5B10A157
	dc.l	$1C0B2408,$1F60A301,$035C1CCB,$00A63680,$1032060C
	dc.l	$04500103,$BD12E0A0,$6D827856,$0BAA0428,$E0EC5603
	dc.l	$41810191,$40054DD4,$30038141,$04A1FF03,$80CA0103
	dc.l	$80A80552,$3410A020,$6C1030E4,$85031C0A,$07E57A0F
	dc.l	$607037F3,$F7F44057,$EFF01406,$07680C0C,$30418081
	dc.l	$DD010314,$0206C02E,$0040E003,$81B514D0,$281E8518
	dc.l	$24007483,$07006823,$09929810,$C0206405,$60124128
	dc.l	$06070030,$00809001,$01602020,$40620004,$1E04000E
	dc.l	$00606000,$800207FE,$00001010
IntroLostDataEnd
