
		; Skidmarks disk imager
		;
		; Written by JOTD
		;
		; Sector format description:
		;
		; sync ($4489)

		incdir	Include:
		include	RawDIC.i

		OUTPUT	"Skidmarks.islave"

		IFND	.passchk
		DOSCMD	"WDate  >T:date"
.passchk
		ENDC

		SLAVE_HEADER
		dc.b	1	; Slave version
		dc.b	0	; Slave flags
		dc.l	DSK_1	; Pointer to the first disk structure
		dc.l	Text	; Pointer to the text displayed in the imager window

		dc.b	"$V","ER:"
Text		dc.b	"Skidmarks imager 1.0",10
		dc.b	"by JOTD on "
		INCBIN	"T:date"
		dc.b	0
		cnop	0,4

DSK_1		dc.l	DSK_2		; Pointer to next disk structure
		dc.w	1		; Disk structure version
		dc.w	DFLG_NORESTRICTIONS		; Disk flags
		dc.l	TL_1		; List of tracks which contain data
		dc.l	0		; UNUSED, ALWAYS SET TO 0!
		dc.l	tracks_0	; List of files to be saved
		dc.l	0		; Table of certain tracks with CRC values
		dc.l	0		; Alternative disk structure, if CRC failed
		dc.l	0		; Called before a disk is read
		dc.l	0		; Called after a disk has been read

DSK_2		dc.l	DSK_3		; Pointer to next disk structure
		dc.w	1		; Disk structure version
		dc.w	DFLG_NORESTRICTIONS		; Disk flags
		dc.l	TL_2		; List of tracks which contain data
		dc.l	0		; UNUSED, ALWAYS SET TO 0!
		dc.l	tracks_1	; List of files to be saved
		dc.l	0		; Table of certain tracks with CRC values
		dc.l	0		; Alternative disk structure, if CRC failed
		dc.l	0		; Called before a disk is read
		dc.l	0		; Called after a disk has been read

DSK_3		dc.l	0		; Pointer to next disk structure
		dc.w	1		; Disk structure version
		dc.w	DFLG_NORESTRICTIONS		; Disk flags
		dc.l	TL_3		; List of tracks which contain data
		dc.l	0		; UNUSED, ALWAYS SET TO 0!
		dc.l	cars_aga	; List of files to be saved
		dc.l	0		; Table of certain tracks with CRC values
		dc.l	0		; Alternative disk structure, if CRC failed
		dc.l	0		; Called before a disk is read
		dc.l	0		; Called after a disk has been read

TRACK_LENGTH = $1800

DEFTRACK:MACRO
	TLENTRY	\1,\1,TRACK_LENGTH,SYNC_STD,DMFM_Skidmarks
	ENDM

tracks_0
	FLENTRY	tr0_HEADNAME,$1800,20622
	FLENTRY	tr0_MAP0NAME,$6890,107306
	FLENTRY	tr0_MAP1NAME,$20BC0,112768
	FLENTRY	tr0_MAP2NAME,$3C440,105162
	FLENTRY	tr0_MAP3NAME,$55F10,98168
	FLENTRY	tr0_MAP4NAME,$6DE88,117272
	FLENTRY	tr0_MAP5NAME,$8A8A0,114022
;	FLENTRY	tr0_TRAKNAME,$0,4
	FLEND

tracks_1
	FLENTRY	tr1_HEADNAME,$1800,20622
	FLENTRY	tr1_MAP0NAME,$6890,108452
	FLENTRY	tr1_MAP1NAME,$21038,101594
	FLENTRY	tr1_MAP2NAME,$39D18,106166
	FLENTRY	tr1_MAP3NAME,$53BD0,100636
	FLENTRY	tr1_MAP4NAME,$6C4F0,104466
	FLENTRY	tr1_MAP5NAME,$85D08,83212
;	FLENTRY	tr1_TRAKNAME,$0,4
	FLEND

cars_aga
	FLENTRY	car_PORSNAME,$1800,225280
	FLENTRY	car_CAMANAME,$38800,243248
	FLENTRY	car_TRUCNAME,$73E30,273736
	FLENTRY	car_BUGGNAME,$B6B78,225128
	FLEND

DEF_TRACK_NAME:MACRO
tr0_\1NAME:
	dc.b	"TR0/","\1",0
tr1_\1NAME:
	dc.b	"TR1/","\1",0
	ENDM

DEF_CAR_NAME:MACRO
car_\1NAME:
	dc.b	"AGA/","\1",0
	ENDM

	DEF_TRACK_NAME	HEAD
	DEF_TRACK_NAME	MAP0
	DEF_TRACK_NAME	MAP1
	DEF_TRACK_NAME	MAP2
	DEF_TRACK_NAME	MAP3
	DEF_TRACK_NAME	MAP4
	DEF_TRACK_NAME	MAP5
;	DEF_TRACK_NAME	TRAK

	DEF_CAR_NAME	BUGG
	DEF_CAR_NAME	CAMA
	DEF_CAR_NAME	PORS
	DEF_CAR_NAME	TRUC

TL_1
	DEFTRACK	159
	DEFTRACK	158
	DEFTRACK	157
	DEFTRACK	156
	DEFTRACK	155
	DEFTRACK	154
	DEFTRACK	153
	DEFTRACK	152
	DEFTRACK	151
	DEFTRACK	150
	DEFTRACK	149
	DEFTRACK	148
	DEFTRACK	147
	DEFTRACK	146
	DEFTRACK	145
	DEFTRACK	144
	DEFTRACK	143
	DEFTRACK	142
	DEFTRACK	141
	DEFTRACK	140
	DEFTRACK	139
	DEFTRACK	138
	DEFTRACK	137
	DEFTRACK	136
	DEFTRACK	135
	DEFTRACK	134
	DEFTRACK	133
	DEFTRACK	132
	DEFTRACK	131
	DEFTRACK	130
	DEFTRACK	129
	DEFTRACK	128
	DEFTRACK	127
	DEFTRACK	126
	DEFTRACK	125
	DEFTRACK	124
	DEFTRACK	123
	DEFTRACK	122
	DEFTRACK	121
	DEFTRACK	120
	DEFTRACK	119
	DEFTRACK	118
	DEFTRACK	117
	DEFTRACK	116
	DEFTRACK	115
	DEFTRACK	114
	DEFTRACK	113
	DEFTRACK	112
	DEFTRACK	111
	DEFTRACK	110
	DEFTRACK	109
	DEFTRACK	108
	DEFTRACK	107
	DEFTRACK	106
	DEFTRACK	105
	DEFTRACK	104
	DEFTRACK	103
	DEFTRACK	102
	DEFTRACK	101
	DEFTRACK	100
	DEFTRACK	99
	DEFTRACK	98
	DEFTRACK	97
	DEFTRACK	96
	DEFTRACK	95
	DEFTRACK	94
	DEFTRACK	93
	DEFTRACK	92
	DEFTRACK	91
	DEFTRACK	90
	DEFTRACK	89
	DEFTRACK	88
	DEFTRACK	87
	DEFTRACK	86
	DEFTRACK	85
	DEFTRACK	84
	DEFTRACK	83
	DEFTRACK	82
	DEFTRACK	81
	DEFTRACK	80
	DEFTRACK	79
	DEFTRACK	78
	DEFTRACK	77
	DEFTRACK	76
	DEFTRACK	75
	DEFTRACK	74
	DEFTRACK	73
	DEFTRACK	72
	DEFTRACK	71
	DEFTRACK	70
	DEFTRACK	69
	DEFTRACK	68
	DEFTRACK	67
	DEFTRACK	66
	DEFTRACK	65
	DEFTRACK	64
	DEFTRACK	63
	DEFTRACK	62
	DEFTRACK	61
	DEFTRACK	60
	DEFTRACK	59
	DEFTRACK	58
	DEFTRACK	57
	DEFTRACK	56
	DEFTRACK	55
	DEFTRACK	54
	DEFTRACK	53
	DEFTRACK	52
	DEFTRACK	51
	DEFTRACK	50
	DEFTRACK	49

	TLEND

TL_2
	DEFTRACK	159
	DEFTRACK	158
	DEFTRACK	157
	DEFTRACK	156
	DEFTRACK	155
	DEFTRACK	154
	DEFTRACK	153
	DEFTRACK	152
	DEFTRACK	151
	DEFTRACK	150
	DEFTRACK	149
	DEFTRACK	148
	DEFTRACK	147
	DEFTRACK	146
	DEFTRACK	145
	DEFTRACK	144
	DEFTRACK	143
	DEFTRACK	142
	DEFTRACK	141
	DEFTRACK	140
	DEFTRACK	139
	DEFTRACK	138
	DEFTRACK	137
	DEFTRACK	136
	DEFTRACK	135
	DEFTRACK	134
	DEFTRACK	133
	DEFTRACK	132
	DEFTRACK	131
	DEFTRACK	130
	DEFTRACK	129
	DEFTRACK	128
	DEFTRACK	127
	DEFTRACK	126
	DEFTRACK	125
	DEFTRACK	124
	DEFTRACK	123
	DEFTRACK	122
	DEFTRACK	121
	DEFTRACK	120
	DEFTRACK	119
	DEFTRACK	118
	DEFTRACK	117
	DEFTRACK	116
	DEFTRACK	115
	DEFTRACK	114
	DEFTRACK	113
	DEFTRACK	112
	DEFTRACK	111
	DEFTRACK	110
	DEFTRACK	109
	DEFTRACK	108
	DEFTRACK	107
	DEFTRACK	106
	DEFTRACK	105
	DEFTRACK	104
	DEFTRACK	103
	DEFTRACK	102
	DEFTRACK	101
	DEFTRACK	100
	DEFTRACK	99
	DEFTRACK	98
	DEFTRACK	97
	DEFTRACK	96
	DEFTRACK	95
	DEFTRACK	94
	DEFTRACK	93
	DEFTRACK	92
	DEFTRACK	91
	DEFTRACK	90
	DEFTRACK	89
	DEFTRACK	88
	DEFTRACK	87
	DEFTRACK	86
	DEFTRACK	85
	DEFTRACK	84
	DEFTRACK	83
	DEFTRACK	82
	DEFTRACK	81
	DEFTRACK	80
	DEFTRACK	79
	DEFTRACK	78
	DEFTRACK	77
	DEFTRACK	76
	DEFTRACK	75
	DEFTRACK	74
	DEFTRACK	73
	DEFTRACK	72
	DEFTRACK	71
	DEFTRACK	70
	DEFTRACK	69
	DEFTRACK	68
	DEFTRACK	67
	DEFTRACK	66
	DEFTRACK	65
	DEFTRACK	64
	DEFTRACK	63
	DEFTRACK	62
	DEFTRACK	61
	DEFTRACK	60
	DEFTRACK	59
	DEFTRACK	58
	DEFTRACK	57

	TLEND

TL_3
	DEFTRACK	159
	DEFTRACK	158
	DEFTRACK	157
	DEFTRACK	156
	DEFTRACK	155
	DEFTRACK	154
	DEFTRACK	153
	DEFTRACK	152
	DEFTRACK	151
	DEFTRACK	150
	DEFTRACK	149
	DEFTRACK	148
	DEFTRACK	147
	DEFTRACK	146
	DEFTRACK	145
	DEFTRACK	144
	DEFTRACK	143
	DEFTRACK	142
	DEFTRACK	141
	DEFTRACK	140
	DEFTRACK	139
	DEFTRACK	138
	DEFTRACK	137
	DEFTRACK	136
	DEFTRACK	135
	DEFTRACK	134
	DEFTRACK	133
	DEFTRACK	132
	DEFTRACK	131
	DEFTRACK	130
	DEFTRACK	129
	DEFTRACK	128
	DEFTRACK	127
	DEFTRACK	126
	DEFTRACK	125
	DEFTRACK	124
	DEFTRACK	123
	DEFTRACK	122
	DEFTRACK	121
	DEFTRACK	120
	DEFTRACK	119
	DEFTRACK	118
	DEFTRACK	117
	DEFTRACK	116
	DEFTRACK	115
	DEFTRACK	114
	DEFTRACK	113
	DEFTRACK	112
	DEFTRACK	111
	DEFTRACK	110
	DEFTRACK	109
	DEFTRACK	108
	DEFTRACK	107
	DEFTRACK	106
	DEFTRACK	105
	DEFTRACK	104
	DEFTRACK	103
	DEFTRACK	102
	DEFTRACK	101
	DEFTRACK	100
	DEFTRACK	99
	DEFTRACK	98
	DEFTRACK	97
	DEFTRACK	96
	DEFTRACK	95
	DEFTRACK	94
	DEFTRACK	93
	DEFTRACK	92
	DEFTRACK	91
	DEFTRACK	90
	DEFTRACK	89
	DEFTRACK	88
	DEFTRACK	87
	DEFTRACK	86
	DEFTRACK	85
	DEFTRACK	84
	DEFTRACK	83
	DEFTRACK	82
	DEFTRACK	81
	DEFTRACK	80
	DEFTRACK	79
	DEFTRACK	78
	DEFTRACK	77
	DEFTRACK	76
	DEFTRACK	75
	DEFTRACK	74
	DEFTRACK	73
	DEFTRACK	72
	DEFTRACK	71
	DEFTRACK	70
	DEFTRACK	69
	DEFTRACK	68
	DEFTRACK	67
	DEFTRACK	66
	DEFTRACK	65
	DEFTRACK	64
	DEFTRACK	63
	DEFTRACK	62
	DEFTRACK	61
	DEFTRACK	60
	DEFTRACK	59
	DEFTRACK	58
	DEFTRACK	57
	DEFTRACK	56
	DEFTRACK	55
	DEFTRACK	54
	DEFTRACK	53
	DEFTRACK	52
	DEFTRACK	51
	DEFTRACK	50
	DEFTRACK	49
	DEFTRACK	48
	DEFTRACK	47
	DEFTRACK	46
	DEFTRACK	45
	DEFTRACK	44
	DEFTRACK	43
	DEFTRACK	42
	DEFTRACK	41
	DEFTRACK	40
	DEFTRACK	39
	DEFTRACK	38
	DEFTRACK	37
	DEFTRACK	36
	DEFTRACK	35
	DEFTRACK	34
	DEFTRACK	33
	DEFTRACK	32
	DEFTRACK	31
	DEFTRACK	30
	DEFTRACK	29
	DEFTRACK	28
	DEFTRACK	27
	DEFTRACK	26
	DEFTRACK	25
	DEFTRACK	24
	DEFTRACK	23
	DEFTRACK	22
	DEFTRACK	21
	DEFTRACK	20
	DEFTRACK	19
	DEFTRACK	18
	DEFTRACK	17
	DEFTRACK	16
	DEFTRACK	15
	DEFTRACK	14
	DEFTRACK	13
	DEFTRACK	12
	DEFTRACK	11
	DEFTRACK	10
	DEFTRACK	9
	DEFTRACK	8
	DEFTRACK	7
	DEFTRACK	6
	DEFTRACK	5
	DEFTRACK	4
	DEFTRACK	3
	DEFTRACK	2
	DEFTRACK	1

		TLEND

;======================================================================

DMFM_Skidmarks
	MOVEA.L	A0,A2			; MFM data
	MOVEA.L	A1,A3			; destination

	move.l	A3,A0

	move.l	A2,A1

	addq.l	#2,A1
	LEA	$1808(A1),A2
	MOVE.L	#$55555555,D2
	MOVE.W	#$05FF,D3
.LB_1498
	bsr	.decode
	MOVE.L	D0,(A0)+
	DBF	D3,.LB_1498
	
	bsr	.decode	
	bsr	.decode	
	move.l	d0,d5	; d5: expected track checksum

	MOVE.L	A3,A0
	CLR.L	D0
	MOVE.W	#$05FF,D3
.LB_14BC
	MOVE.L	(A0)+,D4
	ADDX.L	D4,D0
	DBF	D3,.LB_14BC

	MOVE.L	#$FFFFFFFF,D1
	SUB.L	D0,D1

	MOVEQ	#$00,D0
	CMP.L	D5,D1
	BNE.B	_ChecksumError
	RTS	

.decode
	MOVE.L	(A1)+,D0
	AND.L	D2,D0
	ADD.L	D0,D0
	MOVE.L	(A2)+,D1
	AND.L	D2,D1
	OR.L	D1,D0
	rts

_OK		moveq	#IERR_OK,d0
		rts

_ChecksumError	moveq	#IERR_CHECKSUM,d0
		rts

_NoSector	moveq	#IERR_NOSECTOR,d0
		rts
